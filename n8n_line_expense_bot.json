{
  "name": "LINE è¨˜å¸³æ©Ÿå™¨äºº",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-webhook",
        "options": {}
      },
      "name": "LINE Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "id": "webhook-line"
    },
    {
      "parameters": {
        "functionCode": "// è§£æ LINE webhook è³‡æ–™\nconst events = $json.events;\nif (!events || events.length === 0) {\n  return [];\n}\n\nconst event = events[0];\nconst messageText = event.message?.text || '';\nconst userId = event.source?.userId || '';\nconst replyToken = event.replyToken || '';\n\nreturn [{\n  messageText,\n  userId,\n  replyToken,\n  timestamp: new Date().toISOString()\n}];"
      },
      "name": "è§£æ LINE è³‡æ–™",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300],
      "id": "parse-line-data"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.messageText }}",
              "operation": "equal",
              "value2": "æŸ¥è©¢"
            }
          ]
        }
      },
      "name": "åˆ¤æ–·ï¼šæŸ¥è©¢æŒ‡ä»¤",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 200],
      "id": "check-query"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.messageText }}",
              "operation": "equal",
              "value2": "æœ¬æœˆ"
            }
          ]
        }
      },
      "name": "åˆ¤æ–·ï¼šæœ¬æœˆæŒ‡ä»¤",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300],
      "id": "check-monthly"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.messageText }}",
              "operation": "equal",
              "value2": "å¹«åŠ©"
            }
          ]
        }
      },
      "name": "åˆ¤æ–·ï¼šå¹«åŠ©æŒ‡ä»¤",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 400],
      "id": "check-help"
    },
    {
      "parameters": {
        "functionCode": "// è§£æé‡‘é¡çš„é‚è¼¯\nconst text = $json.messageText;\n\n// é‡‘é¡åŒ¹é…æ¨¡å¼\nconst amountPatterns = [\n  /(\\d+(?:\\.\\d+)?)\\s*å…ƒ/,\n  /(\\d+(?:\\.\\d+)?)\\s*å¡Š/,\n  /NT\\$?\\s*(\\d+(?:\\.\\d+)?)/,\n  /\\$\\s*(\\d+(?:\\.\\d+)?)/,\n  /èŠ±äº†?\\s*(\\d+(?:\\.\\d+)?)/,\n  /(\\d+(?:\\.\\d+)?)\\s*éŒ¢/\n];\n\nlet amount = null;\nfor (const pattern of amountPatterns) {\n  const match = text.match(pattern);\n  if (match) {\n    amount = parseFloat(match[1]);\n    break;\n  }\n}\n\n// å¦‚æœæ²’æœ‰æ˜ç¢ºæ¨¡å¼ï¼Œå°‹æ‰¾ç´”æ•¸å­—\nif (!amount) {\n  const numbers = text.match(/\\d+(?:\\.\\d+)?/g);\n  if (numbers) {\n    amount = Math.max(...numbers.map(n => parseFloat(n)));\n  }\n}\n\n// åœ°é»è­˜åˆ¥\nconst locationKeywords = ['åœ¨', 'æ–¼', 'åˆ°', 'å»', 'è²·', 'åƒ'];\nlet location = null;\n\nfor (const keyword of locationKeywords) {\n  const regex = new RegExp(`${keyword}([^ï¼Œ,ã€‚ï¼ï¼Ÿ\\\\s]+)`);\n  const match = text.match(regex);\n  if (match) {\n    location = match[1].trim();\n    break;\n  }\n}\n\n// é¡åˆ¥è­˜åˆ¥\nconst categoryMap = {\n  'é¤å»³': 'é¤é£²', 'åƒ': 'é¤é£²', 'åˆé¤': 'é¤é£²', 'å’–å•¡': 'é¤é£²',\n  'è¶…å¸‚': 'è³¼ç‰©', 'è²·': 'è³¼ç‰©', 'è¡£æœ': 'è³¼ç‰©',\n  'è»Šè²»': 'äº¤é€š', 'åœè»Š': 'äº¤é€š', 'æ·é‹': 'äº¤é€š',\n  'é›»å½±': 'å¨›æ¨‚', 'ktv': 'å¨›æ¨‚',\n  'é†«é™¢': 'é†«ç™‚', 'è¨ºæ‰€': 'é†«ç™‚'\n};\n\nlet category = 'å…¶ä»–';\nfor (const [keyword, cat] of Object.entries(categoryMap)) {\n  if (text.toLowerCase().includes(keyword)) {\n    category = cat;\n    break;\n  }\n}\n\nreturn [{\n  ...$json,\n  amount,\n  location,\n  category,\n  isValidExpense: amount && amount > 0\n}];"
      },
      "name": "è§£æé‡‘é¡åœ°é»é¡åˆ¥",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 500],
      "id": "parse-expense"
    },
    {
      "parameters": {
        "functionCode": "const { amount, location, category, isValidExpense } = $json;\n\nif (!isValidExpense) {\n  return [{\n    replyText: `ğŸ¤” ç„¡æ³•è­˜åˆ¥é‡‘é¡: \"${$json.messageText}\"\\n\\nğŸ’¡ è«‹è©¦è©¦:\\nâ€¢ \"åœ¨7-11è²·é£²æ–™50å…ƒ\"\\nâ€¢ \"åˆé¤èŠ±äº†120å¡Š\"\\nâ€¢ \"åœè»Šè²»30å…ƒ\"`\n  }];\n}\n\nlet response = `âœ… è¨˜å¸³æˆåŠŸï¼\\n\\nğŸ’° é‡‘é¡: ${amount} å…ƒ`;\nif (location) response += `\\nğŸ“ åœ°é»: ${location}`;\nif (category) response += `\\nğŸ·ï¸ é¡åˆ¥: ${category}`;\n\n// æ¨¡æ“¬è¨˜éŒ„ç·¨è™Ÿ\nconst expenseId = Math.floor(Math.random() * 1000) + 1;\nresponse += `\\n\\nè¨˜éŒ„ç·¨è™Ÿ: #${expenseId}`;\n\nreturn [{ \n  replyText: response,\n  replyToken: $json.replyToken \n}];"
      },
      "name": "çµ„è£è¨˜å¸³å›æ‡‰",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 500],
      "id": "format-expense-response"
    },
    {
      "parameters": {
        "functionCode": "return [{\n  replyText: `ğŸ¤– LINE è¨˜å¸³æ©Ÿå™¨äºº\\n\\nğŸ’¬ æ”¯æ´çš„è¨Šæ¯æ ¼å¼:\\nâ€¢ \"åœ¨7-11è²·é£²æ–™50å…ƒ\"\\nâ€¢ \"åˆé¤èŠ±äº†120å¡Š\"\\nâ€¢ \"åœè»Šè²»30å…ƒ\"\\nâ€¢ \"æ˜Ÿå·´å…‹å’–å•¡150\"\\n\\nğŸ“‹ æŒ‡ä»¤:\\nâ€¢ \"æŸ¥è©¢\" - æŸ¥çœ‹æœ€è¿‘è¨˜éŒ„\\nâ€¢ \"æœ¬æœˆ\" - æœ¬æœˆæ”¯å‡ºæ‘˜è¦\\nâ€¢ \"å¹«åŠ©\" - é¡¯ç¤ºæ­¤èªªæ˜\\n\\nğŸ·ï¸ è‡ªå‹•åˆ†é¡ï¼šé¤é£²ã€è³¼ç‰©ã€äº¤é€šã€å¨›æ¨‚ã€é†«ç™‚`,\n  replyToken: $json.replyToken\n}];"
      },
      "name": "å¹«åŠ©å›æ‡‰",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 400],
      "id": "help-response"
    },
    {
      "parameters": {
        "functionCode": "return [{\n  replyText: `ğŸ“‹ æœ€è¿‘æ”¯å‡ºè¨˜éŒ„ (æ¼”ç¤º):\\n\\n#1 - 12/15 14:30\\nğŸ’° 89.0 å…ƒ | ğŸ“ éº¥ç•¶å‹ | ğŸ·ï¸ é¤é£²\\n\\n#2 - 12/15 12:15\\nğŸ’° 26.0 å…ƒ | ğŸ·ï¸ äº¤é€š\\n\\n#3 - 12/14 19:45\\nğŸ’° 150.0 å…ƒ | ğŸ“ æ˜Ÿå·´å…‹ | ğŸ·ï¸ é¤é£²\\n\\nç¸½è¨ˆ: 265.0 å…ƒ\\n\\nğŸ’¡ é€™æ˜¯æ¼”ç¤ºè³‡æ–™ï¼Œå¯¦éš›ä½¿ç”¨éœ€è¦é€£æ¥è³‡æ–™åº«`,\n  replyToken: $json.replyToken\n}];"
      },
      "name": "æŸ¥è©¢å›æ‡‰",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 200],
      "id": "query-response"
    },
    {
      "parameters": {
        "functionCode": "const currentDate = new Date();\nconst currentYear = currentDate.getFullYear();\nconst currentMonth = currentDate.getMonth() + 1;\n\nreturn [{\n  replyText: `ğŸ“Š ${currentYear}å¹´${currentMonth}æœˆæ”¯å‡ºæ‘˜è¦ (æ¼”ç¤º):\\n\\nğŸ·ï¸ é¤é£²: 1,250 å…ƒ (8 ç­†)\\nğŸ·ï¸ äº¤é€š: 320 å…ƒ (12 ç­†)\\nğŸ·ï¸ è³¼ç‰©: 890 å…ƒ (5 ç­†)\\nğŸ·ï¸ å¨›æ¨‚: 500 å…ƒ (2 ç­†)\\n\\nğŸ’³ ç¸½æ”¯å‡º: 2,960 å…ƒ\\nğŸ“ ç¸½ç­†æ•¸: 27 ç­†\\nğŸ“ˆ å¹³å‡: 109.6 å…ƒ/ç­†\\n\\nğŸ’¡ é€™æ˜¯æ¼”ç¤ºè³‡æ–™ï¼Œå¯¦éš›ä½¿ç”¨éœ€è¦é€£æ¥è³‡æ–™åº«`,\n  replyToken: $json.replyToken\n}];"
      },
      "name": "æœ¬æœˆæ‘˜è¦å›æ‡‰",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 300],
      "id": "monthly-response"
    },
    {
      "parameters": {
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {},
        "requestMethod": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer YOUR_CHANNEL_ACCESS_TOKEN"
            },
            {
              "name": "Content-Type", 
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonParameters": {
          "parameters": [
            {
              "name": "replyToken",
              "value": "={{ $json.replyToken }}"
            },
            {
              "name": "messages",
              "value": [
                {
                  "type": "text",
                  "text": "={{ $json.replyText }}"
                }
              ]
            }
          ]
        }
      },
      "name": "å›æ‡‰ LINE",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1120, 350],
      "id": "reply-line"
    }
  ],
  "connections": {
    "LINE Webhook": {
      "main": [
        [
          {
            "node": "è§£æ LINE è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æ LINE è³‡æ–™": {
      "main": [
        [
          {
            "node": "åˆ¤æ–·ï¼šæŸ¥è©¢æŒ‡ä»¤",
            "type": "main",
            "index": 0
          },
          {
            "node": "åˆ¤æ–·ï¼šæœ¬æœˆæŒ‡ä»¤",
            "type": "main",
            "index": 0
          },
          {
            "node": "åˆ¤æ–·ï¼šå¹«åŠ©æŒ‡ä»¤",
            "type": "main",
            "index": 0
          },
          {
            "node": "è§£æé‡‘é¡åœ°é»é¡åˆ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–·ï¼šæŸ¥è©¢æŒ‡ä»¤": {
      "main": [
        [
          {
            "node": "æŸ¥è©¢å›æ‡‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–·ï¼šæœ¬æœˆæŒ‡ä»¤": {
      "main": [
        [
          {
            "node": "æœ¬æœˆæ‘˜è¦å›æ‡‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–·ï¼šå¹«åŠ©æŒ‡ä»¤": {
      "main": [
        [
          {
            "node": "å¹«åŠ©å›æ‡‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æé‡‘é¡åœ°é»é¡åˆ¥": {
      "main": [
        [
          {
            "node": "çµ„è£è¨˜å¸³å›æ‡‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµ„è£è¨˜å¸³å›æ‡‰": {
      "main": [
        [
          {
            "node": "å›æ‡‰ LINE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¹«åŠ©å›æ‡‰": {
      "main": [
        [
          {
            "node": "å›æ‡‰ LINE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŸ¥è©¢å›æ‡‰": {
      "main": [
        [
          {
            "node": "å›æ‡‰ LINE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ¬æœˆæ‘˜è¦å›æ‡‰": {
      "main": [
        [
          {
            "node": "å›æ‡‰ LINE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "line-expense-bot"
} 